#!/bin/bash
# Pre-commit hook for claudex marketplace validation
#
# Installation:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or symlink:
#   ln -sf ../../scripts/pre-commit .git/hooks/pre-commit

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo "Running claudex marketplace validation..."

# Check if marketplace.json or skills are being committed
STAGED_FILES=$(git diff --cached --name-only)

# Check if relevant files are staged
if echo "$STAGED_FILES" | grep -qE '(marketplace\.json|skills/|plugins/)'; then
    echo "Marketplace or skill files staged, running validation..."

    # Run marketplace validation
    if python3 scripts/validate-marketplace.py; then
        echo -e "${GREEN}Marketplace validation passed${NC}"
    else
        echo -e "${RED}Marketplace validation failed${NC}"
        echo "Fix the errors above before committing."
        exit 1
    fi

    # Run skill validation if skills are modified
    if echo "$STAGED_FILES" | grep -qE 'skills/'; then
        echo "Running skill validation..."
        if python3 scripts/validate-skills.py --all; then
            echo -e "${GREEN}Skill validation passed${NC}"
        else
            echo -e "${YELLOW}Skill validation had warnings (see above)${NC}"
            # Don't fail on warnings, only errors
        fi
    fi
else
    echo "No marketplace/skill files staged, skipping validation."
fi

echo -e "${GREEN}Pre-commit checks passed${NC}"
exit 0
