name: Validate Skills

on:
  pull_request:
    paths:
      - 'skills/**'
  push:
    branches:
      - main
    paths:
      - 'skills/**'

jobs:
  validate-skills:
    name: Validate Skill Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml pylint black mypy anthropic pydantic

      - name: Validate Python syntax in examples
        run: |
          echo "üîç Validating Python syntax..."
          find skills -name "*.py" -type f | while read file; do
            echo "Checking $file"
            python -m py_compile "$file" || exit 1
          done
          echo "‚úÖ All Python files have valid syntax"

      - name: Validate SKILL.md frontmatter
        run: |
          echo "üîç Validating SKILL.md frontmatter..."
          python3 << 'EOF'
          import yaml
          import sys
          from pathlib import Path

          # Per Anthropic docs, only name and description are required
          required_fields = ['name', 'description']
          errors = []

          for skill_file in Path('skills').rglob('SKILL.md'):
              print(f"Checking {skill_file}")

              with open(skill_file) as f:
                  content = f.read()

              # Extract frontmatter
              if not content.startswith('---'):
                  errors.append(f"{skill_file}: Missing frontmatter")
                  continue

              parts = content.split('---', 2)
              if len(parts) < 3:
                  errors.append(f"{skill_file}: Invalid frontmatter structure")
                  continue

              try:
                  frontmatter = yaml.safe_load(parts[1])
              except yaml.YAMLError as e:
                  errors.append(f"{skill_file}: Invalid YAML - {e}")
                  continue

              # Check required fields
              for field in required_fields:
                  if field not in frontmatter:
                      errors.append(f"{skill_file}: Missing required field '{field}'")

          if errors:
              print("‚ùå Frontmatter validation errors:")
              for error in errors:
                  print(f"  - {error}")
              sys.exit(1)

          print("‚úÖ All SKILL.md frontmatter is valid")
          EOF

      - name: Check line count thresholds
        run: |
          echo "üîç Checking skill line count thresholds..."
          python3 << 'EOF'
          import sys
          from pathlib import Path

          # Per Anthropic docs, SKILL.md should be <= 200 lines (acts as menu)
          # We use 300 as threshold to allow some flexibility
          TARGET_LINES = 200
          THRESHOLD = 300

          warnings = []
          errors = []

          for skill_file in Path('skills').rglob('SKILL.md'):
              with open(skill_file) as f:
                  lines = len(f.readlines())

              skill_name = skill_file.parent.name

              print(f"{skill_name}: {lines} lines (target: {TARGET_LINES})")

              if lines > THRESHOLD:
                  errors.append(
                      f"{skill_file}: {lines} lines exceeds threshold of {THRESHOLD} "
                      f"(target: {TARGET_LINES} for progressive disclosure)"
                  )
              elif lines > TARGET_LINES:
                  warnings.append(
                      f"{skill_file}: {lines} lines exceeds target of {TARGET_LINES}"
                  )

          if warnings:
              print("\n‚ö†Ô∏è  Line count warnings (consider refactoring):")
              for warning in warnings:
                  print(f"  - {warning}")

          if errors:
              print("\n‚ùå Line count threshold violations:")
              for error in errors:
                  print(f"  - {error}")
              sys.exit(1)

          print("\n‚úÖ All skills within line count thresholds")
          EOF

      - name: Validate file structure
        run: |
          echo "üîç Validating skill directory structure..."
          python3 << 'EOF'
          import sys
          from pathlib import Path

          errors = []

          # Find all skill directories (contain SKILL.md)
          skill_dirs = [p.parent for p in Path('skills').rglob('SKILL.md')]

          for skill_dir in skill_dirs:
              print(f"Checking {skill_dir}")

              # Required files per Anthropic docs
              required_files = ['SKILL.md', 'README.md', 'CHANGELOG.md']
              for req_file in required_files:
                  file_path = skill_dir / req_file
                  if not file_path.exists():
                      errors.append(f"{skill_dir}: Missing {req_file}")

              # Recommended directories (info only, not errors)
              # Progressive disclosure directories are recommended but not required
              # as simple skills may not need them

          if errors:
              print("‚ùå File structure validation errors:")
              for error in errors:
                  print(f"  - {error}")
              sys.exit(1)

          print("‚úÖ All skills have correct file structure")
          EOF

      - name: Check for broken internal links
        run: |
          echo "üîç Checking for broken internal links..."
          python3 << 'EOF'
          import re
          import sys
          from pathlib import Path

          errors = []

          # Pattern for markdown links: [text](path)
          link_pattern = re.compile(r'\[([^\]]+)\]\(([^)]+)\)')
          # Pattern for fenced code blocks
          code_block_pattern = re.compile(r'```[\s\S]*?```', re.MULTILINE)

          for md_file in Path('skills').rglob('*.md'):
              with open(md_file) as f:
                  content = f.read()

              # Remove code blocks before checking links
              # (links in code blocks are examples, not real links)
              content_without_code = code_block_pattern.sub('', content)

              for match in link_pattern.finditer(content_without_code):
                  link_text = match.group(1)
                  link_path = match.group(2)

                  # Skip external links
                  if link_path.startswith(('http://', 'https://', '#')):
                      continue

                  # Resolve relative path
                  target = (md_file.parent / link_path).resolve()

                  if not target.exists():
                      errors.append(
                          f"{md_file}:\n"
                          f"  Broken link: [{link_text}]({link_path})\n"
                          f"  Target not found: {target}"
                      )

          if errors:
              print("‚ùå Broken link errors:")
              for error in errors:
                  print(f"  {error}")
              sys.exit(1)

          print("‚úÖ All internal links are valid")
          EOF

      - name: Lint Python examples (optional warnings)
        continue-on-error: true
        run: |
          echo "üîç Linting Python examples..."
          find skills -name "*.py" -type f | while read file; do
            echo "Linting $file"
            pylint "$file" --disable=all --enable=E || true
          done

      - name: Check Python formatting
        continue-on-error: true
        run: |
          echo "üîç Checking Python formatting..."
          find skills -name "*.py" -type f -exec black --check {} + || echo "‚ö†Ô∏è  Some files need formatting (run 'black .')"

      - name: Summary
        if: success()
        run: |
          echo "================================"
          echo "‚úÖ All skill validations passed!"
          echo "================================"
          echo ""
          echo "Validated:"
          echo "  - Python syntax"
          echo "  - SKILL.md frontmatter"
          echo "  - Line count thresholds"
          echo "  - File structure"
          echo "  - Internal links"
          echo ""
          echo "Skills are ready for review!"
